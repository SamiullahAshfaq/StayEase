<!-- Airbnb-style Header -->
<header class="header-container">
  <div class="header-content">
    <!-- Logo and Navigation -->
    <div class="logo-nav-section">
      <!-- Logo -->
      <a routerLink="/" class="logo">
        <svg class="logo-icon" viewBox="0 0 32 32" fill="currentColor">
          <path d="M16 1c2 0 3.46.96 4.75 3.27L23.25 9l2.5 4.73L28.5 19c.5 1.08.5 2.05 0 2.82-.63 1-1.85 1.23-3.27 1.13L16 21.5l-9.23 1.45c-1.42.1-2.64-.13-3.27-1.13-.5-.77-.5-1.74 0-2.82l2.75-5.27 2.5-4.73L11.25 4.27C12.54 1.96 14 1 16 1zm0 2c-1.08 0-2.05.5-3.08 2.48L10.42 10l-2.5 4.73L5.23 20c-.32.58-.32 1.02 0 1.32.32.27.82.4 1.53.33L16 20.32l9.24 1.33c.7.07 1.21-.06 1.53-.33.32-.3.32-.74 0-1.32l-2.69-5.27-2.5-4.73-2.5-4.52C18.05 2.5 17.08 2 16 2z"/>
        </svg>
        <span class="logo-text">stayease</span>
      </a>

      <!-- Desktop Navigation -->
      <nav class="desktop-nav">
        <a routerLink="/listing/search" class="nav-link">Stays</a>
        <a routerLink="/services" class="nav-link">Services</a>
        @if (isAuthenticated) {
          <a routerLink="/listing/create" class="nav-link">Become a Host</a>
        }
      </nav>
    </div>

    <!-- Search Bar -->
    <div class="search-container" [class.expanded]="isSearchExpanded()">
      <div class="search-bar" (click)="setActiveSection('where')" (keydown.enter)="setActiveSection('where')" tabindex="0" role="search" aria-label="Search properties">
        <!-- Where Section -->
        <div class="search-section"
             [class.active]="activeSearchSection() === 'where'"
             (click)="$event.stopPropagation(); setActiveSection('where')"
             (keydown.enter)="$event.stopPropagation(); setActiveSection('where')"
             tabindex="0"
             role="button"
             aria-label="Select destination">
          <span class="search-label">Where</span>
          <input
            type="text"
            class="search-input"
            placeholder="Search destinations"
            [(ngModel)]="searchDestination"
            (click)="$event.stopPropagation(); setActiveSection('where')"
          />
        </div>

        <div class="search-divider"></div>

        <!-- Check In Section -->
        <div class="search-section"
             [class.active]="activeSearchSection() === 'when'"
             (click)="$event.stopPropagation(); setActiveSection('when')"
             (keydown.enter)="$event.stopPropagation(); setActiveSection('when')"
             tabindex="0"
             role="button"
             aria-label="Select check-in date">
          <span class="search-label">Check in</span>
          <div class="search-input">
            {{ checkInDate() ? (checkInDate() | date: 'MMM d') : 'Add dates' }}
          </div>
        </div>

        <div class="search-divider"></div>

        <!-- Check Out Section -->
        <div class="search-section"
             [class.active]="activeSearchSection() === 'when'"
             (click)="$event.stopPropagation(); setActiveSection('when')"
             (keydown.enter)="$event.stopPropagation(); setActiveSection('when')"
             tabindex="0"
             role="button"
             aria-label="Select check-out date">
          <span class="search-label">Check out</span>
          <div class="search-input">
            {{ checkOutDate() ? (checkOutDate() | date: 'MMM d') : 'Add dates' }}
          </div>
        </div>

        <div class="search-divider"></div>

        <!-- Who Section -->
        <div class="search-section guests-section"
             [class.active]="activeSearchSection() === 'who'"
             (click)="$event.stopPropagation(); setActiveSection('who')"
             (keydown.enter)="$event.stopPropagation(); setActiveSection('who')"
             tabindex="0"
             role="button"
             aria-label="Select number of guests">
          <span class="search-label">Who</span>
          <div class="search-input">
            {{ getTotalGuests() > 1 ? getGuestText() : 'Add guests' }}
          </div>
        </div>

        <!-- Search Button -->
        <button class="search-button" (click)="$event.stopPropagation(); performSearch()">
          <svg class="search-icon" viewBox="0 0 32 32" fill="none">
            <circle cx="14" cy="14" r="10" stroke="currentColor" stroke-width="3"/>
            <path d="M21 21L27 27" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
          </svg>
          @if (isSearchExpanded()) {
            <span class="search-button-text">Search</span>
          }
        </button>
      </div>

      <!-- Date Picker Dropdown -->
      @if (activeSearchSection() === 'when') {
        <div class="dropdown-panel date-picker-panel" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="dialog" aria-label="Date picker">
          <div class="calendar-container">
            <!-- Calendar Header -->
            <div class="calendar-header">
              <button class="calendar-nav-btn" (click)="previousMonth()">
                <svg viewBox="0 0 32 32" class="calendar-nav-icon">
                  <path d="M20 24L10 16L20 8" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="calendar-month">{{ getMonthName(currentMonth()) }}</div>
              <button class="calendar-nav-btn" (click)="nextMonth()">
                <svg viewBox="0 0 32 32" class="calendar-nav-icon">
                  <path d="M12 8L22 16L12 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            <!-- Weekday Headers -->
            <div class="calendar-weekdays">
              <div class="weekday">Su</div>
              <div class="weekday">Mo</div>
              <div class="weekday">Tu</div>
              <div class="weekday">We</div>
              <div class="weekday">Th</div>
              <div class="weekday">Fr</div>
              <div class="weekday">Sa</div>
            </div>

            <!-- Calendar Days -->
            <div class="calendar-days">
              @for (date of getDaysInMonth(currentMonth()); track date.getTime()) {
                <button
                  class="calendar-day"
                  [class.empty]="date.getTime() === 0"
                  [class.selected]="isDateSelected(date)"
                  [class.in-range]="isDateInRange(date)"
                  (click)="selectDate(date)"
                  [disabled]="date.getTime() === 0"
                >
                  {{ date.getTime() !== 0 ? date.getDate() : '' }}
                </button>
              }
            </div>
          </div>
        </div>
      }

      <!-- Guest Selector Dropdown -->
      @if (activeSearchSection() === 'who') {
        <div class="dropdown-panel guests-panel" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="dialog" aria-label="Guest selector">
          <div class="guest-row">
            <div class="guest-info">
              <div class="guest-title">Adults</div>
              <div class="guest-subtitle">Age 13+</div>
            </div>
            <div class="guest-counter">
              <button
                class="counter-btn"
                [disabled]="guests().adults <= 1"
                (click)="decrementGuests('adults')"
              >
                <svg viewBox="0 0 32 32" class="counter-icon">
                  <path d="M8 16h16" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </button>
              <span class="counter-value">{{ guests().adults }}</span>
              <button
                class="counter-btn"
                (click)="incrementGuests('adults')"
              >
                <svg viewBox="0 0 32 32" class="counter-icon">
                  <path d="M16 8v16M8 16h16" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="guest-divider"></div>

          <div class="guest-row">
            <div class="guest-info">
              <div class="guest-title">Children</div>
              <div class="guest-subtitle">Ages 2-12</div>
            </div>
            <div class="guest-counter">
              <button
                class="counter-btn"
                [disabled]="guests().children <= 0"
                (click)="decrementGuests('children')"
              >
                <svg viewBox="0 0 32 32" class="counter-icon">
                  <path d="M8 16h16" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </button>
              <span class="counter-value">{{ guests().children }}</span>
              <button
                class="counter-btn"
                (click)="incrementGuests('children')"
              >
                <svg viewBox="0 0 32 32" class="counter-icon">
                  <path d="M16 8v16M8 16h16" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="guest-divider"></div>

          <div class="guest-row">
            <div class="guest-info">
              <div class="guest-title">Infants</div>
              <div class="guest-subtitle">Under 2</div>
            </div>
            <div class="guest-counter">
              <button
                class="counter-btn"
                [disabled]="guests().infants <= 0"
                (click)="decrementGuests('infants')"
              >
                <svg viewBox="0 0 32 32" class="counter-icon">
                  <path d="M8 16h16" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </button>
              <span class="counter-value">{{ guests().infants }}</span>
              <button
                class="counter-btn"
                (click)="incrementGuests('infants')"
              >
                <svg viewBox="0 0 32 32" class="counter-icon">
                  <path d="M16 8v16M8 16h16" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Right Side Menu -->
    <div class="right-menu">
      @if (isAuthenticated) {
        <div class="user-menu">
          <button class="menu-button" (click)="toggleMenu()" aria-label="User menu" aria-expanded="{{ isMenuOpen }}">
            <svg class="menu-icon" viewBox="0 0 32 32" fill="none">
              <rect x="6" y="8" width="20" height="2" fill="currentColor"/>
              <rect x="6" y="15" width="20" height="2" fill="currentColor"/>
              <rect x="6" y="22" width="20" height="2" fill="currentColor"/>
            </svg>
            @if (currentUser && currentUser.profileImageUrl) {
              <img 
                [src]="getProfileImageUrl()" 
                alt="Profile" 
                class="user-avatar"
                (error)="onImageError($event)"
                (load)="onImageLoad()">
            } @else {
              <div class="user-avatar-placeholder">
                {{ (currentUser?.firstName || 'U').charAt(0).toUpperCase() }}
              </div>
            }
          </button>

          @if (isMenuOpen) {
            <div class="user-dropdown">
              <!-- User Info Header -->
              <div class="user-dropdown-header">
                <div class="user-dropdown-name">
                  {{ (currentUser?.firstName && currentUser?.lastName) ? (currentUser?.firstName + ' ' + currentUser?.lastName) : 'User' }}
                </div>
                <div class="user-dropdown-email">
                  {{ currentUser?.email || '' }}
                </div>
                <div class="user-dropdown-role">
                  {{ getPrimaryRole() }}
                </div>
              </div>

              <div class="dropdown-divider"></div>

              <!-- Account Options -->
              <div class="dropdown-section">
                <button (click)="navigateToBookings()" class="dropdown-item">
                  <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>My Bookings</span>
                </button>

                <!-- My Favorites - Available for all users -->
                <button (click)="navigateToFavorites()" class="dropdown-item">
                  <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>My Favourites</span>
                </button>

                <!-- My Listings - Only for Landlords and Admins (hidden for pure tenants) -->
                @if (isLandlordOrAdmin()) {
                  <button (click)="navigateToMyListings()" class="dropdown-item">
                    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>My Listings</span>
                  </button>
                  
                  <!-- Analytics Dashboard -->
                  <button (click)="navigateToAnalytics()" class="dropdown-item">
                    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Analytics</span>
                  </button>
                }

                <!-- Add Listing - Only for Landlords and Admins -->
                @if (isLandlordOrAdmin()) {
                  <button (click)="navigateToAddListing()" class="dropdown-item highlight-item">
                    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M12 4v16m8-8H4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Add Listing</span>
                  </button>
                }

                <!-- Service Provider Options - Only for Service Providers -->
                @if (isServiceProvider()) {
                  <button (click)="navigateToMyServices()" class="dropdown-item">
                    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>My Services</span>
                  </button>

                  <button (click)="navigateToAddService()" class="dropdown-item highlight-item">
                    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M12 4v16m8-8H4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Add Service</span>
                  </button>
                }

                <button (click)="navigateToProfile()" class="dropdown-item">
                  <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>Profile</span>
                </button>
              </div>

              <div class="dropdown-divider"></div>

              <!-- Logout -->
              <button (click)="logout()" class="dropdown-item logout-item">
                <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Log out</span>
              </button>
            </div>
          }
        </div>
      } @else {
        <div class="auth-menu">
          <button class="menu-button guest-menu" (click)="toggleMenu()" aria-label="User menu" aria-expanded="{{ isMenuOpen }}">
            <svg class="menu-icon" viewBox="0 0 32 32" fill="none">
              <rect x="6" y="8" width="20" height="2" fill="currentColor"/>
              <rect x="6" y="15" width="20" height="2" fill="currentColor"/>
              <rect x="6" y="22" width="20" height="2" fill="currentColor"/>
            </svg>
            <div class="user-avatar-placeholder guest-avatar">
              <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
            </div>
          </button>

          @if (isMenuOpen) {
            <div class="user-dropdown">
              <!-- Guest Options -->
              <div class="dropdown-section">
                <button (click)="login()" class="dropdown-item">
                  <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>Log in</span>
                </button>

                <button (click)="signup()" class="dropdown-item">
                  <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>Sign up</span>
                </button>
              </div>

              <div class="dropdown-divider"></div>

              <div class="dropdown-section">
                <button (click)="navigateToBookings()" class="dropdown-item">
                  <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>My Bookings</span>
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
</header>
