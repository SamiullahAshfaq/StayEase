<div class="create-listing-container">
  <!-- Progress Header -->
  <div class="progress-header">
    <div class="header-content">
      <h1>Create a New Listing</h1>
      <button class="cancel-btn" (click)="cancel()">Cancel</button>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>

    <div class="step-indicators">
      @for (step of [1, 2, 3, 4, 5, 6, 7]; track step) {
      <div class="step-indicator"
           [class.active]="step === currentStep()"
           [class.completed]="step < currentStep()"
           tabindex="0"
           role="button"
           [attr.aria-label]="'Go to step ' + step"
           (click)="goToStep(step)"
           (keyup.enter)="goToStep(step)"
           (keyup.space)="goToStep(step)">
        <div class="step-number">{{ step }}</div>
        <div class="step-label">
          @if (step === 1) { <span>Basics</span> }
          @if (step === 2) { <span>Details</span> }
          @if (step === 3) { <span>Photos</span> }
          @if (step === 4) { <span>Description</span> }
          @if (step === 5) { <span>Pricing</span> }
          @if (step === 6) { <span>Policies</span> }
          @if (step === 7) { <span>Preview</span> }
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Error Message -->
  @if (error()) {
  <div class="error-banner">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    {{ error() }}
  </div>
  }

  <!-- Step Content -->
  <div class="step-content">
    <!-- Step 1: Property Basics -->
    @if (currentStep() === 1) {
    <div class="step-panel">
      <h2>Tell us about your property</h2>
      <p class="step-description">Let's start with the basics</p>

      <div class="form-group">
        <div class="form-label required">Property Type</div>
        <div class="selection-grid">
          @for (type of [PropertyType.APARTMENT, PropertyType.HOUSE, PropertyType.VILLA, PropertyType.CONDO, PropertyType.TOWNHOUSE, PropertyType.COTTAGE, PropertyType.CABIN, PropertyType.STUDIO, PropertyType.LOFT]; track type) {
          <div class="selection-card"
               [class.selected]="formData().propertyType === type"
               tabindex="0"
               role="button"
               [attr.aria-label]="getPropertyTypeLabel(type)"
               (click)="selectPropertyType(type)"
               (keyup.enter)="selectPropertyType(type)"
               (keyup.space)="selectPropertyType(type)">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="4" y="4" width="16" height="16" rx="2"/>
            </svg>
            <span>{{ getPropertyTypeLabel(type) }}</span>
          </div>
          }
        </div>
      </div>

      <div class="form-group">
        <div class="form-label required">Room Type</div>
        <div class="selection-grid">
          @for (type of [RoomType.ENTIRE_PLACE, RoomType.PRIVATE_ROOM, RoomType.SHARED_ROOM]; track type) {
          <div class="selection-card"
               [class.selected]="formData().roomType === type"
               tabindex="0"
               role="button"
               [attr.aria-label]="getRoomTypeLabel(type)"
               (click)="selectRoomType(type)"
               (keyup.enter)="selectRoomType(type)"
               (keyup.space)="selectRoomType(type)">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            </svg>
            <span>{{ getRoomTypeLabel(type) }}</span>
          </div>
          }
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="city-input" class="form-label required">City</label>
          <input id="city-input"
                 type="text"
                 class="form-input"
                 [(ngModel)]="formData().city"
                 placeholder="Enter city">
        </div>
        <div class="form-group">
          <label for="country-input" class="form-label required">Country</label>
          <input id="country-input"
                 type="text"
                 class="form-input"
                 [(ngModel)]="formData().country"
                 placeholder="Enter country">
        </div>
      </div>

      <div class="form-group">
        <label for="address-input" class="form-label">Street Address</label>
        <input id="address-input"
               type="text"
               class="form-input"
               [(ngModel)]="formData().address"
               placeholder="Enter street address">
      </div>

      <div class="form-group">
        <label for="zipcode-input" class="form-label">Zip Code</label>
        <input id="zipcode-input"
               type="text"
               class="form-input"
               [(ngModel)]="formData().zipCode"
               placeholder="Enter zip code">
      </div>
    </div>
    }

    <!-- Step 2: Property Details -->
    @if (currentStep() === 2) {
    <div class="step-panel">
      <h2>Share some details about your place</h2>
      <p class="step-description">Tell guests what your property has to offer</p>

      <div class="form-group">
        <div class="form-label required">Bedrooms</div>
        <div class="counter-input">
          <button type="button" aria-label="Decrease bedrooms" (click)="formData().bedrooms > 1 && updateFormField('bedrooms', formData().bedrooms - 1)">-</button>
          <span>{{ formData().bedrooms }}</span>
          <button type="button" aria-label="Increase bedrooms" (click)="updateFormField('bedrooms', formData().bedrooms + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <div class="form-label required">Bathrooms</div>
        <div class="counter-input">
          <button type="button" aria-label="Decrease bathrooms" (click)="formData().bathrooms > 1 && updateFormField('bathrooms', formData().bathrooms - 1)">-</button>
          <span>{{ formData().bathrooms }}</span>
          <button type="button" aria-label="Increase bathrooms" (click)="updateFormField('bathrooms', formData().bathrooms + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <div class="form-label required">Maximum Guests</div>
        <div class="counter-input">
          <button type="button" aria-label="Decrease guests" (click)="formData().maxGuests > 1 && updateFormField('maxGuests', formData().maxGuests - 1)">-</button>
          <span>{{ formData().maxGuests }}</span>
          <button type="button" aria-label="Increase guests" (click)="updateFormField('maxGuests', formData().maxGuests + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <div class="form-label">Amenities</div>
        <div class="checkbox-grid">
          @for (amenity of availableAmenities; track amenity) {
          <label class="checkbox-label">
            <input type="checkbox"
                   [checked]="formData().amenities.includes(amenity)"
                   (change)="toggleAmenity(amenity)">
            <span>{{ amenity }}</span>
          </label>
          }
        </div>
      </div>
    </div>
    }

    <!-- Step 3: Photos -->
    @if (currentStep() === 3) {
    <div class="step-panel">
      <h2>Add photos of your property</h2>
      <p class="step-description">Upload at least 5 high-quality photos</p>

      <div class="upload-zone"
           tabindex="0"
           role="button"
           aria-label="Upload photos"
           (click)="fileInput.click()"
           (keyup.enter)="fileInput.click()"
           (keyup.space)="fileInput.click()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
        <h3>Click to upload photos</h3>
        <p>Or drag and drop</p>
        <input #fileInput
               type="file"
               multiple
               accept="image/*"
               style="display: none"
               (change)="onFileSelect($event)">
      </div>

      @if (formData().imagePreviewUrls.length > 0) {
      <div class="image-grid">
        @for (url of formData().imagePreviewUrls; track $index) {
        <div class="image-preview">
          <img [src]="url" [alt]="'Preview ' + ($index + 1)">
          <button class="remove-image" (click)="removeImage($index)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
          @if ($index === 0) {
          <div class="primary-badge">Primary</div>
          }
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- Step 4: Title & Description -->
    @if (currentStep() === 4) {
    <div class="step-panel">
      <h2>Create your listing title and description</h2>
      <p class="step-description">Make it catchy and informative</p>

      <div class="form-group">
        <label for="title-input" class="form-label required">Title</label>
        <input id="title-input"
               type="text"
               class="form-input"
               [(ngModel)]="formData().title"
               placeholder="e.g., Beautiful 2BR Apartment with Ocean View"
               maxlength="100">
        <small>{{ formData().title.length }}/100 characters</small>
      </div>

      <div class="form-group">
        <label for="description-input" class="form-label required">Description</label>
        <textarea id="description-input"
                  class="form-textarea"
                  [(ngModel)]="formData().description"
                  placeholder="Describe your property, the neighborhood, and what makes it special..."
                  rows="8"
                  maxlength="1000"></textarea>
        <small>{{ formData().description.length }}/1000 characters</small>
      </div>

      <div class="form-group">
        <label for="house-rules-input" class="form-label">House Rules</label>
        <textarea id="house-rules-input"
                  class="form-textarea"
                  [(ngModel)]="formData().houseRules"
                  placeholder="e.g., No smoking, No pets, Quiet hours after 10 PM..."
                  rows="4"></textarea>
      </div>
    </div>
    }

    <!-- Step 5: Pricing -->
    @if (currentStep() === 5) {
    <div class="step-panel">
      <h2>Set your pricing</h2>
      <p class="step-description">You can always change this later</p>

      <div class="form-group">
        <label for="base-price-input" class="form-label required">Base Price per Night ($)</label>
        <input id="base-price-input"
               type="number"
               class="form-input"
               [(ngModel)]="formData().basePrice"
               placeholder="0"
               min="0">
      </div>

      <div class="form-group">
        <label for="cleaning-fee-input" class="form-label">Cleaning Fee ($)</label>
        <input id="cleaning-fee-input"
               type="number"
               class="form-input"
               [(ngModel)]="formData().cleaningFee"
               placeholder="0"
               min="0">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="weekly-discount-input" class="form-label">Weekly Discount (%)</label>
          <input id="weekly-discount-input"
                 type="number"
                 class="form-input"
                 [(ngModel)]="formData().weeklyDiscount"
                 placeholder="0"
                 min="0"
                 max="100">
        </div>
        <div class="form-group">
          <label for="monthly-discount-input" class="form-label">Monthly Discount (%)</label>
          <input id="monthly-discount-input"
                 type="number"
                 class="form-input"
                 [(ngModel)]="formData().monthlyDiscount"
                 placeholder="0"
                 min="0"
                 max="100">
        </div>
      </div>

      <div class="pricing-summary">
        <h3>Pricing Summary</h3>
        <div class="summary-row">
          <span>Base price</span>
          <span class="price">${{ formData().basePrice }}</span>
        </div>
        @if (formData().cleaningFee) {
        <div class="summary-row">
          <span>Cleaning fee</span>
          <span class="price">${{ formData().cleaningFee }}</span>
        </div>
        }
        @if (formData().weeklyDiscount) {
        <div class="summary-row">
          <span>Weekly discount</span>
          <span class="discount">-{{ formData().weeklyDiscount }}%</span>
        </div>
        }
        @if (formData().monthlyDiscount) {
        <div class="summary-row">
          <span>Monthly discount</span>
          <span class="discount">-{{ formData().monthlyDiscount }}%</span>
        </div>
        }
      </div>
    </div>
    }

    <!-- Step 6: Policies -->
    @if (currentStep() === 6) {
    <div class="step-panel">
      <h2>Set your house rules and policies</h2>
      <p class="step-description">Let guests know what to expect</p>

      <div class="form-row">
        <div class="form-group">
          <label for="checkin-time-input" class="form-label">Check-in Time</label>
          <input id="checkin-time-input"
                 type="time"
                 class="form-input"
                 [(ngModel)]="formData().checkInTime">
        </div>
        <div class="form-group">
          <label for="checkout-time-input" class="form-label">Check-out Time</label>
          <input id="checkout-time-input"
                 type="time"
                 class="form-input"
                 [(ngModel)]="formData().checkOutTime">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="min-nights-input" class="form-label">Minimum Nights</label>
          <input id="min-nights-input"
                 type="number"
                 class="form-input"
                 [(ngModel)]="formData().minNights"
                 min="1">
        </div>
        <div class="form-group">
          <label for="max-nights-input" class="form-label">Maximum Nights</label>
          <input id="max-nights-input"
                 type="number"
                 class="form-input"
                 [(ngModel)]="formData().maxNights"
                 min="1">
        </div>
      </div>
    </div>
    }

    <!-- Step 7: Preview -->
    @if (currentStep() === 7) {
    <div class="step-panel">
      <h2>Review your listing</h2>
      <p class="step-description">Make sure everything looks good</p>

      <div class="preview-card">
        <div class="preview-images">
          @if (formData().imagePreviewUrls[0]) {
          <img [src]="formData().imagePreviewUrls[0]"
               alt="Main photo">
          }
        </div>

        <div class="preview-content">
          <h3>{{ formData().title }}</h3>
          <p class="preview-type">
            {{ getPropertyTypeLabel(formData().propertyType!) }} Â·
            {{ getRoomTypeLabel(formData().roomType!) }}
          </p>
          <p class="preview-location">{{ formData().city }}, {{ formData().country }}</p>

          <div class="preview-details">
            <span>{{ formData().bedrooms }} beds</span>
            <span>{{ formData().bathrooms }} baths</span>
            <span>{{ formData().maxGuests }} guests</span>
          </div>

          <p class="preview-description">{{ formData().description }}</p>

          <div class="preview-price">
            <span class="price">${{ formData().basePrice }}</span>
            <span class="label">per night</span>
          </div>

          @if (formData().amenities.length) {
          <div class="preview-amenities">
            <h4>Amenities</h4>
            <div class="amenity-tags">
              @for (amenity of formData().amenities; track amenity) {
              <span class="amenity-tag">{{ amenity }}</span>
              }
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Navigation Buttons -->
  <div class="navigation-buttons">
    @if (currentStep() > 1) {
    <button class="btn-secondary"
            (click)="previousStep()"
            [disabled]="loading()">
      Back
    </button>
    }

    <div class="right-buttons">
      <button class="btn-outline"
              (click)="saveDraft()"
              [disabled]="loading()">
        Save as Draft
      </button>

      @if (currentStep() < totalSteps) {
      <button class="btn-primary"
              (click)="nextStep()"
              [disabled]="loading()">
        Next
      </button>
      }

      @if (currentStep() === totalSteps) {
      <button class="btn-primary"
              (click)="publishListing()"
              [disabled]="loading()">
        @if (!loading()) { <span>Publish Listing</span> }
        @if (loading()) { <span>Publishing...</span> }
      </button>
      }
    </div>
  </div>
</div>
