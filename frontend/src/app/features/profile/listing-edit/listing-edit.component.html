<div class="edit-listing-container" *ngIf="!loading()">
  <!-- Progress Header -->
  <div class="progress-header">
    <div class="header-content">
      <h1>Edit Listing</h1>
      <button class="cancel-btn" (click)="cancel()">Cancel</button>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>
    
    <div class="step-indicators">
      <div *ngFor="let step of [1, 2, 3, 4, 5, 6, 7]" 
           class="step-indicator" 
           [class.active]="step === currentStep()"
           [class.completed]="step < currentStep()"
           (click)="goToStep(step)">
        <div class="step-number">{{ step }}</div>
        <div class="step-label">
          <span *ngIf="step === 1">Basics</span>
          <span *ngIf="step === 2">Details</span>
          <span *ngIf="step === 3">Photos</span>
          <span *ngIf="step === 4">Description</span>
          <span *ngIf="step === 5">Pricing</span>
          <span *ngIf="step === 6">Policies</span>
          <span *ngIf="step === 7">Preview</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error()" class="error-banner">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    {{ error() }}
  </div>

  <!-- Step Content - Reusing same structure as create component -->
  <div class="step-content">
    <!-- Step 1: Property Basics -->
    <div *ngIf="currentStep() === 1" class="step-panel">
      <h2>Property Basics</h2>
      <p class="step-description">Update your property information</p>

      <div class="form-group">
        <label class="form-label required">Property Type</label>
        <div class="selection-grid">
          <div *ngFor="let type of [PropertyType.APARTMENT, PropertyType.HOUSE, PropertyType.VILLA, PropertyType.CONDO, PropertyType.TOWNHOUSE, PropertyType.COTTAGE, PropertyType.CABIN, PropertyType.BUNGALOW, PropertyType.STUDIO, PropertyType.LOFT]"
               class="selection-card"
               [class.selected]="formData().propertyType === type"
               (click)="selectPropertyType(type)">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="4" y="4" width="16" height="16" rx="2"/>
            </svg>
            <span>{{ propertyTypeLabels[type] }}</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label required">Room Type</label>
        <div class="selection-grid">
          <div *ngFor="let type of [RoomType.ENTIRE_PLACE, RoomType.PRIVATE_ROOM, RoomType.SHARED_ROOM]"
               class="selection-card"
               [class.selected]="formData().roomType === type"
               (click)="selectRoomType(type)">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            </svg>
            <span>{{ roomTypeLabels[type] }}</span>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label required">City</label>
          <input type="text" 
                 class="form-input" 
                 [(ngModel)]="formData().city"
                 placeholder="Enter city">
        </div>
        <div class="form-group">
          <label class="form-label required">Country</label>
          <input type="text" 
                 class="form-input" 
                 [(ngModel)]="formData().country"
                 placeholder="Enter country">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Street Address</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="formData().address"
               placeholder="Enter street address">
      </div>

      <div class="form-group">
        <label class="form-label">Zip Code</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="formData().zipCode"
               placeholder="Enter zip code">
      </div>
    </div>

    <!-- Step 2: Property Details -->
    <div *ngIf="currentStep() === 2" class="step-panel">
      <h2>Property Details</h2>
      <p class="step-description">Update your property details</p>

      <div class="form-group">
        <label class="form-label required">Bedrooms</label>
        <div class="counter-input">
          <button type="button" (click)="formData().bedrooms > 1 && updateFormField('bedrooms', formData().bedrooms - 1)">-</button>
          <span>{{ formData().bedrooms }}</span>
          <button type="button" (click)="updateFormField('bedrooms', formData().bedrooms + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label required">Bathrooms</label>
        <div class="counter-input">
          <button type="button" (click)="formData().bathrooms > 1 && updateFormField('bathrooms', formData().bathrooms - 1)">-</button>
          <span>{{ formData().bathrooms }}</span>
          <button type="button" (click)="updateFormField('bathrooms', formData().bathrooms + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label required">Maximum Guests</label>
        <div class="counter-input">
          <button type="button" (click)="formData().maxGuests > 1 && updateFormField('maxGuests', formData().maxGuests - 1)">-</button>
          <span>{{ formData().maxGuests }}</span>
          <button type="button" (click)="updateFormField('maxGuests', formData().maxGuests + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Property Size (sq ft)</label>
        <input type="number" 
               class="form-input" 
               [(ngModel)]="formData().propertySize"
               placeholder="Enter property size">
      </div>

      <div class="form-group">
        <label class="form-label">Amenities</label>
        <div class="checkbox-grid">
          <label *ngFor="let amenity of availableAmenities" class="checkbox-label">
            <input type="checkbox" 
                   [checked]="formData().amenities.includes(amenity)"
                   (change)="toggleAmenity(amenity)">
            <span>{{ amenity }}</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Step 3: Photos -->
    <div *ngIf="currentStep() === 3" class="step-panel">
      <h2>Update Photos</h2>
      <p class="step-description">Manage your property photos</p>

      <!-- Existing Images -->
      <div *ngIf="formData().existingImages.length > 0">
        <h3 class="subsection-title">Current Photos</h3>
        <div class="image-grid">
          <div *ngFor="let image of formData().existingImages; let i = index" class="image-preview">
            <img [src]="image.imageUrl" [alt]="'Photo ' + (i + 1)">
            <button class="remove-image" (click)="removeExistingImage(image.id)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
            <div *ngIf="i === 0" class="primary-badge">Primary</div>
          </div>
        </div>
      </div>

      <!-- Upload New Images -->
      <h3 class="subsection-title" style="margin-top: 24px;">Add New Photos</h3>
      <div class="upload-zone" (click)="fileInput.click()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
        <h3>Click to upload new photos</h3>
        <p>Or drag and drop</p>
        <input #fileInput 
               type="file" 
               multiple 
               accept="image/*" 
               style="display: none"
               (change)="onFileSelect($event)">
      </div>

      <!-- New Images Preview -->
      <div *ngIf="formData().imagePreviewUrls.length > 0">
        <h3 class="subsection-title" style="margin-top: 24px;">New Photos (Not Saved Yet)</h3>
        <div class="image-grid">
          <div *ngFor="let url of formData().imagePreviewUrls; let i = index" class="image-preview">
            <img [src]="url" [alt]="'New preview ' + (i + 1)">
            <button class="remove-image" (click)="removeImage(i)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Steps 4-7: Same as create component -->
    <!-- Step 4: Title & Description -->
    <div *ngIf="currentStep() === 4" class="step-panel">
      <h2>Title and Description</h2>
      <p class="step-description">Update your listing information</p>

      <div class="form-group">
        <label class="form-label required">Title</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="formData().title"
               placeholder="e.g., Beautiful 2BR Apartment with Ocean View"
               maxlength="100">
        <small>{{ formData().title.length }}/100 characters</small>
      </div>

      <div class="form-group">
        <label class="form-label required">Description</label>
        <textarea class="form-textarea" 
                  [(ngModel)]="formData().description"
                  placeholder="Describe your property..."
                  rows="8"
                  maxlength="1000"></textarea>
        <small>{{ formData().description.length }}/1000 characters</small>
      </div>

      <div class="form-group">
        <label class="form-label">House Rules</label>
        <textarea class="form-textarea" 
                  [(ngModel)]="formData().houseRules"
                  placeholder="e.g., No smoking, No pets..."
                  rows="4"></textarea>
      </div>
    </div>

    <!-- Step 5: Pricing -->
    <div *ngIf="currentStep() === 5" class="step-panel">
      <h2>Pricing</h2>
      <p class="step-description">Update your pricing</p>

      <div class="form-group">
        <label class="form-label required">Base Price per Night ($)</label>
        <input type="number" 
               class="form-input" 
               [(ngModel)]="formData().basePrice"
               placeholder="0"
               min="0">
      </div>

      <div class="form-group">
        <label class="form-label">Cleaning Fee ($)</label>
        <input type="number" 
               class="form-input" 
               [(ngModel)]="formData().cleaningFee"
               placeholder="0"
               min="0">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Weekly Discount (%)</label>
          <input type="number" 
                 class="form-input" 
                 [(ngModel)]="formData().weeklyDiscount"
                 placeholder="0"
                 min="0"
                 max="100">
        </div>
        <div class="form-group">
          <label class="form-label">Monthly Discount (%)</label>
          <input type="number" 
                 class="form-input" 
                 [(ngModel)]="formData().monthlyDiscount"
                 placeholder="0"
                 min="0"
                 max="100">
        </div>
      </div>

      <div class="pricing-summary">
        <h3>Pricing Summary</h3>
        <div class="summary-row">
          <span>Base price</span>
          <span class="price">${{ formData().basePrice }}</span>
        </div>
        <div class="summary-row" *ngIf="formData().cleaningFee">
          <span>Cleaning fee</span>
          <span class="price">${{ formData().cleaningFee }}</span>
        </div>
      </div>
    </div>

    <!-- Step 6: Policies -->
    <div *ngIf="currentStep() === 6" class="step-panel">
      <h2>House Rules and Policies</h2>
      <p class="step-description">Update your policies</p>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Check-in Time</label>
          <input type="time" 
                 class="form-input" 
                 [(ngModel)]="formData().checkInTime">
        </div>
        <div class="form-group">
          <label class="form-label">Check-out Time</label>
          <input type="time" 
                 class="form-input" 
                 [(ngModel)]="formData().checkOutTime">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Minimum Nights</label>
          <input type="number" 
                 class="form-input" 
                 [(ngModel)]="formData().minNights"
                 min="1">
        </div>
        <div class="form-group">
          <label class="form-label">Maximum Nights</label>
          <input type="number" 
                 class="form-input" 
                 [(ngModel)]="formData().maxNights"
                 min="1">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Cancellation Policy</label>
        <select class="form-input" [(ngModel)]="formData().cancellationPolicy">
          <option *ngFor="let policy of cancellationPolicies" [value]="policy.value">
            {{ policy.label }}
          </option>
        </select>
      </div>
    </div>

    <!-- Step 7: Preview -->
    <div *ngIf="currentStep() === 7" class="step-panel">
      <h2>Preview Changes</h2>
      <p class="step-description">Review your updates</p>

      <div class="preview-card">
        <div class="preview-images" *ngIf="getAllImages().length > 0">
          <img [src]="getAllImages()[0]" alt="Main photo">
        </div>

        <div class="preview-content">
          <h3>{{ formData().title }}</h3>
          <p class="preview-type">
            {{ propertyTypeLabels[formData().propertyType!] }} Â· 
            {{ roomTypeLabels[formData().roomType!] }}
          </p>
          <p class="preview-location">{{ formData().city }}, {{ formData().country }}</p>
          
          <div class="preview-details">
            <span>{{ formData().bedrooms }} beds</span>
            <span>{{ formData().bathrooms }} baths</span>
            <span>{{ formData().maxGuests }} guests</span>
          </div>

          <p class="preview-description">{{ formData().description }}</p>

          <div class="preview-price">
            <span class="price">${{ formData().basePrice }}</span>
            <span class="label">per night</span>
          </div>

          <div class="preview-amenities" *ngIf="formData().amenities.length">
            <h4>Amenities</h4>
            <div class="amenity-tags">
              <span *ngFor="let amenity of formData().amenities" class="amenity-tag">{{ amenity }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="navigation-buttons">
    <button *ngIf="currentStep() > 1" 
            class="btn-secondary" 
            (click)="previousStep()"
            [disabled]="saving()">
      Back
    </button>
    
    <div class="right-buttons">
      <button *ngIf="currentStep() < totalSteps" 
              class="btn-primary" 
              (click)="nextStep()"
              [disabled]="saving()">
        Next
      </button>
      
      <button *ngIf="currentStep() === totalSteps" 
              class="btn-primary" 
              (click)="saveChanges()"
              [disabled]="saving()">
        <span *ngIf="!saving()">Save Changes</span>
        <span *ngIf="saving()">Saving...</span>
      </button>
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="loading()" class="loading-state">
  <div class="spinner"></div>
  <p>Loading listing...</p>
</div>
