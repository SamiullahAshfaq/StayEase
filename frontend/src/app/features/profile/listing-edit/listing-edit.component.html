@if (!loading()) {
<div class="edit-listing-container">
  <!-- Progress Header -->
  <div class="progress-header">
    <div class="header-content">
      <h1>Edit Listing</h1>
      <button class="cancel-btn" (click)="cancel()">Cancel</button>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>

    <div class="step-indicators">
      @for (step of [1, 2, 3, 4, 5, 6, 7]; track step) {
      <div class="step-indicator"
           [class.active]="step === currentStep()"
           [class.completed]="step < currentStep()"
           tabindex="0"
           role="button"
           (click)="goToStep(step)"
           (keydown.enter)="goToStep(step)"
           (keydown.space)="goToStep(step)">
        <div class="step-number">{{ step }}</div>
        <div class="step-label">
          @if (step === 1) { <span>Basics</span> }
          @if (step === 2) { <span>Details</span> }
          @if (step === 3) { <span>Photos</span> }
          @if (step === 4) { <span>Description</span> }
          @if (step === 5) { <span>Pricing</span> }
          @if (step === 6) { <span>Policies</span> }
          @if (step === 7) { <span>Preview</span> }
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Error Message -->
  @if (error()) {
  <div class="error-banner">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    {{ error() }}
  </div>
  }

  <!-- Step Content - Reusing same structure as create component -->
  <div class="step-content">
    <!-- Step 1: Property Basics -->
    @if (currentStep() === 1) {
    <div class="step-panel">
      <h2>Property Basics</h2>
      <p class="step-description">Update your property information</p>

      <div class="form-group">
        <fieldset>
          <legend class="form-label required">Property Type</legend>
          <div class="selection-grid">
            @for (type of [PropertyType.APARTMENT, PropertyType.HOUSE, PropertyType.VILLA, PropertyType.CONDO, PropertyType.TOWNHOUSE, PropertyType.COTTAGE, PropertyType.CABIN, PropertyType.STUDIO, PropertyType.LOFT]; track type) {
            <div class="selection-card"
                 [class.selected]="formData().propertyType === type"
                 tabindex="0"
                 role="button"
                 (click)="selectPropertyType(type)"
                 (keydown.enter)="selectPropertyType(type)"
                 (keydown.space)="selectPropertyType(type)">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/>
              </svg>
              <span>{{ getPropertyTypeLabel(type) }}</span>
            </div>
            }
          </div>
        </fieldset>
      </div>

      <div class="form-group">
        <fieldset>
          <legend class="form-label required">Room Type</legend>
          <div class="selection-grid">
            @for (type of [RoomType.ENTIRE_PLACE, RoomType.PRIVATE_ROOM, RoomType.SHARED_ROOM]; track type) {
            <div class="selection-card"
                 [class.selected]="formData().roomType === type"
                 tabindex="0"
                 role="button"
                 (click)="selectRoomType(type)"
                 (keydown.enter)="selectRoomType(type)"
                 (keydown.space)="selectRoomType(type)">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              </svg>
              <span>{{ getRoomTypeLabel(type) }}</span>
            </div>
            }
          </div>
        </fieldset>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="city" class="form-label required">City</label>
          <input type="text"
                 id="city"
                 class="form-input"
                 [(ngModel)]="formData().city"
                 placeholder="Enter city">
        </div>
        <div class="form-group">
          <label for="country" class="form-label required">Country</label>
          <input type="text"
                 id="country"
                 class="form-input"
                 [(ngModel)]="formData().country"
                 placeholder="Enter country">
        </div>
      </div>

      <div class="form-group">
        <label for="address" class="form-label">Street Address</label>
        <input type="text"
               id="address"
               class="form-input"
               [(ngModel)]="formData().address"
               placeholder="Enter street address">
      </div>

      <div class="form-group">
        <label for="zipCode" class="form-label">Zip Code</label>
        <input type="text"
               id="zipCode"
               class="form-input"
               [(ngModel)]="formData().zipCode"
               placeholder="Enter zip code">
      </div>
    </div>
    }

    <!-- Step 2: Property Details -->
    @if (currentStep() === 2) {
    <div class="step-panel">
      <h2>Property Details</h2>
      <p class="step-description">Update your property details</p>

      <div class="form-group">
        <label for="bedrooms" class="form-label required">Bedrooms</label>
        <div class="counter-input">
          <button type="button" (click)="formData().bedrooms > 1 && updateFormField('bedrooms', formData().bedrooms - 1)">-</button>
          <span>{{ formData().bedrooms }}</span>
          <button type="button" (click)="updateFormField('bedrooms', formData().bedrooms + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <label for="bathrooms" class="form-label required">Bathrooms</label>
        <div class="counter-input">
          <button type="button" (click)="formData().bathrooms > 1 && updateFormField('bathrooms', formData().bathrooms - 1)">-</button>
          <span>{{ formData().bathrooms }}</span>
          <button type="button" (click)="updateFormField('bathrooms', formData().bathrooms + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <label for="maxGuests" class="form-label required">Maximum Guests</label>
        <div class="counter-input">
          <button type="button" (click)="formData().maxGuests > 1 && updateFormField('maxGuests', formData().maxGuests - 1)">-</button>
          <span>{{ formData().maxGuests }}</span>
          <button type="button" (click)="updateFormField('maxGuests', formData().maxGuests + 1)">+</button>
        </div>
      </div>

      <div class="form-group">
        <label for="amenities" class="form-label">Amenities</label>
        <div class="checkbox-grid">
          @for (amenity of availableAmenities; track amenity) {
          <label class="checkbox-label">
            <input type="checkbox"
                   [checked]="formData().amenities.includes(amenity)"
                   (change)="toggleAmenity(amenity)">
            <span>{{ amenity }}</span>
          </label>
          }
        </div>
      </div>
    </div>
    }

    <!-- Step 3: Photos -->
    @if (currentStep() === 3) {
    <div class="step-panel">
      <h2>Update Photos</h2>
      <p class="step-description">Manage your property photos</p>

      <!-- Existing Images -->
      @if (formData().existingImages.length > 0) {
      <div>
        <h3 class="subsection-title">Current Photos</h3>
        <div class="image-grid">
          @for (image of formData().existingImages; track image.id) {
          <div class="image-preview">
            <img [src]="image.url" [alt]="'Photo ' + ($index + 1)">
            <button class="remove-image" (click)="removeExistingImage(image.id)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
            @if ($index === 0) {
            <div class="primary-badge">Primary</div>
            }
          </div>
          }
        </div>
      </div>
      }

      <!-- Upload New Images -->
      <h3 class="subsection-title" style="margin-top: 24px;">Add New Photos</h3>
      <div class="upload-zone"
           tabindex="0"
           role="button"
           (click)="fileInput.click()"
           (keydown.enter)="fileInput.click()"
           (keydown.space)="fileInput.click()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
        <h3>Click to upload new photos</h3>
        <p>Or drag and drop</p>
        <input #fileInput
               type="file"
               multiple
               accept="image/*"
               style="display: none"
               (change)="onFileSelect($event)">
      </div>

      <!-- New Images Preview -->
      @if (formData().imagePreviewUrls.length > 0) {
      <div>
        <h3 class="subsection-title" style="margin-top: 24px;">New Photos (Not Saved Yet)</h3>
        <div class="image-grid">
          @for (url of formData().imagePreviewUrls; track $index) {
          <div class="image-preview">
            <img [src]="url" [alt]="'New preview ' + ($index + 1)">
            <button class="remove-image" (click)="removeImage($index)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
          }
        </div>
      </div>
      }
    </div>
    }

    <!-- Steps 4-7: Same as create component -->
    <!-- Step 4: Title & Description -->
    @if (currentStep() === 4) {
    <div class="step-panel">
      <h2>Title and Description</h2>
      <p class="step-description">Update your listing information</p>

      <div class="form-group">
        <label for="title" class="form-label required">Title</label>
        <input type="text"
               id="title"
               class="form-input"
               [(ngModel)]="formData().title"
               placeholder="e.g., Beautiful 2BR Apartment with Ocean View"
               maxlength="100">
        <small>{{ formData().title.length }}/100 characters</small>
      </div>

      <div class="form-group">
        <label for="description" class="form-label required">Description</label>
        <textarea id="description" class="form-textarea"
                  [(ngModel)]="formData().description"
                  placeholder="Describe your property..."
                  rows="8"
                  maxlength="1000"></textarea>
        <small>{{ formData().description.length }}/1000 characters</small>
      </div>

      <div class="form-group">
        <label for="houseRules" class="form-label">House Rules</label>
        <textarea id="houseRules" class="form-textarea"
                  [(ngModel)]="formData().houseRules"
                  placeholder="e.g., No smoking, No pets..."
                  rows="4"></textarea>
      </div>
    </div>
    }

    <!-- Step 5: Pricing -->
    @if (currentStep() === 5) {
    <div class="step-panel">
      <h2>Pricing</h2>
      <p class="step-description">Update your pricing</p>

      <div class="form-group">
        <label for="basePrice" class="form-label required">Base Price per Night ($)</label>
        <input type="number"
               id="basePrice"
               class="form-input"
               [(ngModel)]="formData().basePrice"
               placeholder="0"
               min="0">
      </div>

      <div class="form-group">
        <label for="cleaningFee" class="form-label">Cleaning Fee ($)</label>
        <input type="number"
               id="cleaningFee"
               class="form-input"
               [(ngModel)]="formData().cleaningFee"
               placeholder="0"
               min="0">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="weeklyDiscount" class="form-label">Weekly Discount (%)</label>
          <input type="number"
                 id="weeklyDiscount"
                 class="form-input"
                 [(ngModel)]="formData().weeklyDiscount"
                 placeholder="0"
                 min="0"
                 max="100">
        </div>
        <div class="form-group">
          <label for="monthlyDiscount" class="form-label">Monthly Discount (%)</label>
          <input type="number"
                 id="monthlyDiscount"
                 class="form-input"
                 [(ngModel)]="formData().monthlyDiscount"
                 placeholder="0"
                 min="0"
                 max="100">
        </div>
      </div>

      <div class="pricing-summary">
        <h3>Pricing Summary</h3>
        <div class="summary-row">
          <span>Base price</span>
          <span class="price">${{ formData().basePrice }}</span>
        </div>
        @if (formData().cleaningFee) {
        <div class="summary-row">
          <span>Cleaning fee</span>
          <span class="price">${{ formData().cleaningFee }}</span>
        </div>
        }
      </div>
    </div>
    }

    <!-- Step 6: Policies -->
    @if (currentStep() === 6) {
    <div class="step-panel">
      <h2>House Rules and Policies</h2>
      <p class="step-description">Update your policies</p>

      <div class="form-row">
        <div class="form-group">
          <label for="checkInTime" class="form-label">Check-in Time</label>
          <input type="time"
                 id="checkInTime"
                 class="form-input"
                 [(ngModel)]="formData().checkInTime">
        </div>
        <div class="form-group">
          <label for="checkOutTime" class="form-label">Check-out Time</label>
          <input type="time"
                 id="checkOutTime"
                 class="form-input"
                 [(ngModel)]="formData().checkOutTime">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="minNights" class="form-label">Minimum Nights</label>
          <input type="number"
                 id="minNights"
                 class="form-input"
                 [(ngModel)]="formData().minNights"
                 min="1">
        </div>
        <div class="form-group">
          <label for="maxNights" class="form-label">Maximum Nights</label>
          <input type="number"
                 id="maxNights"
                 class="form-input"
                 [(ngModel)]="formData().maxNights"
                 min="1">
        </div>
      </div>
    </div>
    }

    <!-- Step 7: Preview -->
    @if (currentStep() === 7) {
    <div class="step-panel">
      <h2>Preview Changes</h2>
      <p class="step-description">Review your updates</p>

      <div class="preview-card">
        @if (getAllImages().length > 0) {
        <div class="preview-images">
          <img [src]="getAllImages()[0]" alt="Main photo">
        </div>
        }

        <div class="preview-content">
          <h3>{{ formData().title }}</h3>
          <p class="preview-type">
            {{ getPropertyTypeLabel(formData().propertyType!) }} Â·
            {{ getRoomTypeLabel(formData().roomType!) }}
          </p>
          <p class="preview-location">{{ formData().city }}, {{ formData().country }}</p>

          <div class="preview-details">
            <span>{{ formData().bedrooms }} beds</span>
            <span>{{ formData().bathrooms }} baths</span>
            <span>{{ formData().maxGuests }} guests</span>
          </div>

          <p class="preview-description">{{ formData().description }}</p>

          <div class="preview-price">
            <span class="price">${{ formData().basePrice }}</span>
            <span class="label">per night</span>
          </div>

          @if (formData().amenities.length) {
          <div class="preview-amenities">
            <h4>Amenities</h4>
            <div class="amenity-tags">
              @for (amenity of formData().amenities; track amenity) {
              <span class="amenity-tag">{{ amenity }}</span>
              }
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Navigation Buttons -->
  <div class="navigation-buttons">
    @if (currentStep() > 1) {
    <button class="btn-secondary"
            (click)="previousStep()"
            [disabled]="saving()">
      Back
    </button>
    }

    <div class="right-buttons">
      @if (currentStep() < totalSteps) {
      <button class="btn-primary"
              (click)="nextStep()"
              [disabled]="saving()">
        Next
      </button>
      }

      @if (currentStep() === totalSteps) {
      <button class="btn-primary"
              (click)="saveChanges()"
              [disabled]="saving()">
        @if (!saving()) { <span>Save Changes</span> }
        @if (saving()) { <span>Saving...</span> }
      </button>
      }
    </div>
  </div>
</div>
}

<!-- Loading State -->
@if (loading()) {
<div class="loading-state">
  <div class="spinner"></div>
  <p>Loading listing...</p>
</div>
}
